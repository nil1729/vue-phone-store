<template>
  <div class="container">
    <h1 v-if="isEmpty" class="text-center cart-empty-text mt-5">
      Your Cart is Currently Empty
    </h1>
    <div v-else class="mt-3">
      <h1 class="text-center cart-text m-auto">Your Cart</h1>
      <table class="table mt-4">
        <thead>
          <tr class="text-uppercase">
            <th scope="col">products</th>
            <th scope="col">model</th>
            <th scope="col">price</th>
            <th scope="col">quantity</th>
            <th scope="col">remove</th>
            <th scope="col">total</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="item in cartItems" :key="item._id">
            <th scope="row">
              <div class="image">
                <img
                  :src="item.photoURL"
                  :alt="item._id"
                  class="img-thumbnail img-fluid"
                />
              </div>
            </th>
            <td>{{ item.model }}</td>
            <td class="price">₹ {{ formatPrice(item.price) }}</td>
            <td>
              <div class="btn-group" role="group" aria-label="Basic example">
                <button
                  :disabled="item.quantity < 2"
                  @click="changeQuantity(item._id, -1)"
                  type="button"
                  class="btn btn-outline-info"
                >
                  -
                </button>
                <button type="button" class="btn btn-outline-info">
                  {{ item.quantity }}
                </button>
                <button
                  @click="changeQuantity(item._id, 1)"
                  :disabled="item.quantity > 9"
                  type="button"
                  class="btn btn-outline-info"
                >
                  +
                </button>
              </div>
            </td>
            <td>
              <button @click="remove(item._id)" class="btn btn-lg trash">
                <i class="fad fa-trash"></i>
              </button>
            </td>
            <td class="price">
              ₹ {{ formatPrice(item.price * item.quantity) }}
            </td>
          </tr>
        </tbody>
      </table>
      <div
        class="container d-flex justify-content-center align-items-end flex-column"
      >
        <button
          @click="$store.commit('CLEAR_CART')"
          class="btn btn-outline-danger btn-sm mb-2 clear-cart-btn"
        >
          Clear Cart
        </button>
        <p class="lead text-primary">
          Product Total :
          <span class="ml-2 font-weight-normal text-dark"
            >₹ {{ formatPrice(productTotal) }}</span
          >
        </p>
        <p class="lead text-primary">
          Tax (GST 5%) :
          <span class="ml-2 font-weight-normal text-dark"
            >₹ {{ formatPrice(taxTotal) }}</span
          >
        </p>
        <p class="lead text-primary">
          Grand Total :
          <span class="ml-2 font-weight-normal text-dark"
            >₹ {{ formatPrice((taxTotal + productTotal).toFixed(2)) }}</span
          >
        </p>
        <button @click="testCheckout" class="btn mt-1 mb-4 btn-success">
          Proceed to Checkout
          <i class="ml-1 fal fa-shopping-cart"></i>
        </button>
      </div>
    </div>
  </div>
</template>

<script>
import { mapGetters } from "vuex";
export default {
  name: "Cart-Page",
  data() {
    return {
      isChanged: false,
    };
  },
  computed: {
    ...mapGetters(["formatPrice"]),
    isEmpty: function () {
      return this.$store.state.cart && this.$store.state.cart.length === 0;
    },
    cartItems: function () {
      return this.$store.state.cart;
    },
    productTotal() {
      let total = 0;
      this.$store.state.cart.forEach(
        (item) => (total += item.price * item.quantity)
      );
      return parseFloat(total.toFixed(2));
    },
    taxTotal() {
      return parseFloat(((this.productTotal * 5) / 100).toFixed(2));
    },
  },
  methods: {
    remove(id) {
      this.isChanged = true;
      this.$store.commit("REMOVE_CART_ITEM", id);
    },
    changeQuantity(id, quantity) {
      this.isChanged = true;
      this.$store.commit("CHANGE_ITEM_QUANTITY", { id, quantity });
    },
    // TODO only for Development
    testCheckout() {
      if (confirm("Do you Want to Proceed ?")) {
        alert("Successfully Purchased");
        this.$store.commit("CLEAR_CART");
        this.isChanged = true;
      }
    },
    // Todo: Change this with Backend
  },
  beforeRouteLeave(to, from, next) {
    if (this.isChanged) {
      this.$store.dispatch("saveCartProduct");
    }
    next();
  },
};
</script>

<style scoped>
.cart-empty-text,
.cart-text {
  font-weight: 400;
}
.cart-text {
  border-bottom: 1px solid grey;
  width: fit-content;
}
table {
  border-bottom: 1px solid #dee2e6;
}
.table thead th {
  border-top: none;
}
.table th,
.table td {
  vertical-align: middle;
  text-align: center;
}
.image {
  height: 100px;
  width: 100px;
}
img {
  height: 100%;
}
.price {
  font-weight: 700;
  letter-spacing: 0.5px;
  font-size: 1rem;
}
button {
  box-shadow: none !important;
}
.clear-cart-btn {
  font-weight: 500;
  font-size: 1rem;
  letter-spacing: 0.5px;
}
.trash {
  color: red;
}
.lead {
  font-weight: 500;
}
</style>